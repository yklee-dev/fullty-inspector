<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fullty Inspector (SS/S/A+/A/B)</title>
  <style>
    :root{
      /* Pantone Pistachio Green (approx) */
      --bg: #A9D39E; /* Pistachio Green web approximation */ 
      --text: #000000;
      --muted: rgba(0,0,0,.65);
      --card: rgba(255,255,255,.88);
      --card2: rgba(255,255,255,.96);
      --line: rgba(0,0,0,.2);
      --shadow: rgba(0,0,0,.10);
      --btn: #ffffff;
      --btnLine: rgba(0,0,0,.6);
      --btnHover: rgba(255,255,255,.75);
      --danger: #ff3b5c;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    header .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:#000;
      box-shadow: 0 0 0 4px rgba(0,0,0,.08);
    }
    .brand b{ font-size:14px; letter-spacing:.2px; }
    .brand .sub{ font-size:12px; color: var(--muted); margin-top:2px; }

    main{
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media(min-width: 980px){
      main{ grid-template-columns: 380px 1fr; align-items:start; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 30px var(--shadow);
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
    }

    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
    }

    input, select, textarea{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--card2);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height: 74px; resize: vertical; }

    .row{ display:grid; grid-template-columns: 1fr; gap:10px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .split{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btns{ display:flex; gap:8px; flex-wrap:wrap; }
    button{
      border: 1px solid var(--btnLine);
      background: var(--btn);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: .12s ease;
    }
    button:hover{ background: var(--btnHover); }
    button.primary{
      border-width: 2px;
      font-weight: 700;
    }
    button.danger{
      background: var(--danger);
      border-color: rgba(0,0,0,.25);
      color: #000;
      font-weight:700;
    }
    button.ghost{
      background: transparent;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.6);
      font-size:12px;
      color: var(--muted);
    }
    .pill b{ color: var(--text); }

    .hr{ height:1px; background: var(--line); margin: 10px 0; }

    .muted{ color: var(--muted); font-size:12px; line-height:1.5; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.75);
    }

    .list{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .item{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.72);
      border-radius: 14px;
      padding: 10px;
      cursor:pointer;
    }
    .item:hover{ background: rgba(255,255,255,.88); }
    .item .top{ display:flex; justify-content:space-between; gap:10px; }
    .item .meta{ color: var(--muted); font-size:12px; margin-top:6px; line-height:1.35; }

    .table{ width:100%; border-collapse: collapse; }
    .table th, .table td{
      border-bottom: 1px solid rgba(0,0,0,.12);
      padding: 8px 6px;
      font-size:12px;
      vertical-align: top;
    }
    .table th{
      color: var(--muted);
      text-align:left;
      font-weight: 700;
    }
    .table td input, .table td select{
      padding: 8px;
      border-radius: 10px;
    }
    .right{ text-align:right; }

    .checkgrid{ display:grid; grid-template-columns: 1fr 1fr; gap:6px; }
    @media(min-width: 560px){
      .checkgrid{ grid-template-columns: 1fr 1fr 1fr; }
    }
    .check{
      display:flex; gap:8px; align-items:center;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.72);
      border-radius: 12px;
      padding: 8px;
      font-size: 12px;
    }
    .check input{ width:auto; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      display:none;
      z-index: 999;
      max-width: 92vw;
      box-shadow: 0 12px 40px rgba(0,0,0,.15);
    }

    /* Modal */
    .modalBackdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 1000;
    }
    .modalCard{
      width: min(980px, 100%);
      background: rgba(255,255,255,.95);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 20px 80px rgba(0,0,0,.20);
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <b>Fullty Inspector</b>
        <div class="sub">SS / S / A+ / A / B Â· ìë™ ì‚°ì¶œ Â· ë¡œì»¬ ì €ì¥</div>
      </div>
    </div>

    <div class="split">
      <span class="pill">ì„ íƒ: <b id="selName">ì—†ìŒ</b></span>
      <button class="ghost" id="btnViewData">ë°ì´í„° ë³´ê¸°</button>
      <button class="ghost" id="btnBackup">JSON ë°±ì—…</button>
      <button class="ghost" id="btnRestore">ë³µì›</button>
      <input id="restoreFile" type="file" accept="application/json" style="display:none" />
      <button class="danger" id="btnWipe">ì „ì²´ì‚­ì œ</button>
    </div>
  </div>
</header>

<main>
  <!-- LEFT -->
  <section class="card">
    <h2>ê²€ìˆ˜ ëª©ë¡</h2>

    <div class="row">
      <div>
        <label>ê²€ìƒ‰</label>
        <input id="q" placeholder="ìƒí’ˆëª…/ID/ë“±ê¸‰ìœ¼ë¡œ ê²€ìƒ‰" />
      </div>

      <div class="grid2">
        <div>
          <label>í•„í„°(ë“±ê¸‰)</label>
          <select id="filterGrade">
            <option value="">ì „ì²´</option>
            <option>SS</option>
            <option>S</option>
            <option>A+</option>
            <option>A</option>
            <option>B</option>
            <option>X</option>
          </select>
        </div>
        <div>
          <label>ì •ë ¬</label>
          <select id="sortBy">
            <option value="new">ìµœì‹ </option>
            <option value="old">ì˜¤ë˜ëœ</option>
            <option value="name">ìƒí’ˆëª…</option>
          </select>
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="btnNew">+ ìƒˆ ê²€ìˆ˜</button>
        <button id="btnCSV">CSV ë‚´ë³´ë‚´ê¸°</button>
      </div>

      <div class="muted">
        ë°ì´í„°ëŠ” <b>ì´ ê¸°ê¸°/ë¸Œë¼ìš°ì €</b>ì— ì €ì¥ë¼ìš”. ìºì‹œ ì‚­ì œí•˜ë©´ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆì–´ìš”.<br/>
        ì£¼ 1íšŒ <span class="kbd">JSON ë°±ì—…</span> ì¶”ì²œ.
      </div>
    </div>

    <div class="hr"></div>
    <div class="list" id="list"></div>
  </section>

  <!-- RIGHT -->
  <section class="card">
    <h2>ê²€ìˆ˜ ì…ë ¥</h2>

    <div class="row">
      <div class="grid2">
        <div>
          <label>ìƒí’ˆ ID</label>
          <input id="item_id" placeholder="ìë™ ìƒì„± ë˜ëŠ” ì…ë ¥" />
        </div>
        <div>
          <label>ê²€ìˆ˜ ìƒíƒœ</label>
          <select id="status">
            <option value="draft">draft (ì‘ì„±ì¤‘)</option>
            <option value="final">final (ì™„ë£Œ)</option>
          </select>
        </div>
      </div>

      <div>
        <label>ìƒí’ˆëª…</label>
        <input id="name" placeholder="ì˜ˆ: USM Haller Sideboard (í™”ì´íŠ¸)" />
      </div>

      <div class="grid2">
        <div>
          <label>ì¹´í…Œê³ ë¦¬</label>
          <input id="category" placeholder="ì˜ˆ: í…Œì´ë¸” / ì¡°ëª… / ì†ŒíŒŒ" />
        </div>
        <div>
          <label>ê°€ê²©(ì„ íƒ)</label>
          <input id="price" placeholder="ì˜ˆ: 1,290,000" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>ë°°ì§€(ì½¤ë§ˆ)</label>
          <input id="badges" placeholder="BOX,TAG,CLEANING,VINTAGE,REFURB" />
        </div>
        <div>
          <label>ì‚¬ì§„ ì•¨ë²”/í´ë” ë§í¬(ì„ íƒ)</label>
          <input id="album_link" placeholder="êµ¬ê¸€ë“œë¼ì´ë¸Œ/ì•¨ë²” ë§í¬" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>íŒë§¤ë¶ˆê°€(X) ê²Œì´íŠ¸</label>
          <select id="gate_x">
            <option value="false">ì•„ë‹ˆì˜¤</option>
            <option value="true">ì˜ˆ (ë¦¬í¼/ë°˜ë ¤)</option>
          </select>
        </div>
        <div>
          <label>ê²Œì´íŠ¸ ì‚¬ìœ (ì„ íƒ)</label>
          <input id="gate_reason" placeholder="ì˜ˆ: êµ¬ì¡° íŒŒì† / ì „ê¸° ë¶ˆëŸ‰ / ê³°íŒ¡ì´" />
        </div>
      </div>

      <div class="split">
        <span class="pill">ë“±ê¸‰: <b id="grade">-</b></span>
        <span class="pill">ì‚¬ìš©ê°: <b id="wear_label">-</b></span>
        <span class="pill">ê¸°ì¤€: <b>SS/S/A+/A/B</b></span>
      </div>

      <div class="btns">
        <button class="primary" id="btnCalc">ë“±ê¸‰/ë¬¸êµ¬ ìƒì„±</button>
        <button id="btnSave">ì €ì¥</button>
        <button class="danger" id="btnDelete">ì‚­ì œ</button>
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0;">ê²°í•¨ ì…ë ¥</h2>
      <div class="muted">
        ê²°í•¨ì€ <b>ë…¸ì¶œë©´ + ê°€ì‹œê±°ë¦¬ + ì½”ë“œ + í¬ê¸°/ë©´ì  + ê°œìˆ˜</b>ë¡œë§Œ ì…ë ¥í•´ìš”.
      </div>

      <div style="overflow:auto;">
        <table class="table">
          <thead>
            <tr>
              <th>ë…¸ì¶œë©´</th>
              <th>ê°€ì‹œê±°ë¦¬</th>
              <th>ì½”ë“œ</th>
              <th>ê¸¸ì´(mm)</th>
              <th>ë©´ì (cmÂ²)</th>
              <th>ê°œìˆ˜</th>
              <th>ì¶”ê°€(í•„ë§1~5/êº¼ì§mm ë“±)</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="defBody"></tbody>
        </table>
      </div>

      <div class="btns" style="margin-top:8px;">
        <button id="btnAddDef">+ ê²°í•¨ ì¶”ê°€</button>
        <button class="ghost" id="btnClearDef">ê²°í•¨ ë¹„ìš°ê¸°</button>
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0;">ì‚¬ì§„ ì²´í¬ë¦¬ìŠ¤íŠ¸(20ì¥ ê¶Œì¥)</h2>
      <div class="muted">ì‚¬ì§„ ìì²´ëŠ” ì €ì¥í•˜ì§€ ì•Šê³ , ì´¬ì˜ ì™„ë£Œ ì—¬ë¶€ë§Œ ì²´í¬í•´ìš”.</div>
      <div class="checkgrid" id="photoChecks"></div>

      <div class="hr"></div>

      <h2 style="margin-top:0;">ìë™ ìƒì„± ê²°ê³¼</h2>
      <div class="grid2">
        <div>
          <label>ìš”ì•½ë¬¸(ë³µë¶™ìš©)</label>
          <textarea id="simple_content" readonly></textarea>
          <div class="btns" style="margin-top:8px;">
            <button id="btnCopySimple">ìš”ì•½ ë³µì‚¬</button>
          </div>
        </div>
        <div>
          <label>ìƒì„¸ì„¤ëª… HTML(ë³µë¶™ìš©)</label>
          <textarea id="content_html" readonly></textarea>
          <div class="btns" style="margin-top:8px;">
            <button id="btnCopyHtml">HTML ë³µì‚¬</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <h2 style="margin-top:0;">ë©”ëª¨</h2>
      <textarea id="notes" placeholder="ê²€ìˆ˜ ë©”ëª¨ (CSìš©, ë‚´ë¶€ìš©)"></textarea>
    </div>
  </section>
</main>

<!-- DATA VIEW MODAL -->
<div id="dataModal" class="modalBackdrop" style="display:none;">
  <div class="modalCard">
    <div class="modalTop">
      <div>
        <b>ë°ì´í„° ë³´ê¸° (ì›ë³¸ JSON)</b>
        <div class="muted">í˜„ì¬ ê¸°ê¸°/ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ì „ì²´ ë°ì´í„°ì…ë‹ˆë‹¤.</div>
      </div>
      <div class="btns">
        <button class="ghost" id="btnCopyData">ë³µì‚¬</button>
        <button class="danger" id="btnCloseData">ë‹«ê¸°</button>
      </div>
    </div>
    <div class="hr"></div>
    <textarea id="dataDump" readonly style="width:100%; min-height:55vh;"></textarea>
    <div class="muted" style="margin-top:8px;">
      íŒŒì¼ë¡œ ì €ì¥í•˜ë ¤ë©´ ìƒë‹¨ <span class="kbd">JSON ë°±ì—…</span>ì„ ì“°ëŠ” ê²Œ ê°€ì¥ ì•ˆì „í•´ìš”.
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   Fullty Inspector (No backend)
   Grades: SS / S / A+ / A / B / X
   Storage: localStorage
   ========================= */

const CONFIG = {
  version: "Fullty SS/S/A+/A/B v1",
  storageKey: "fullty_inspector_v2",

  gradeLabels: {
    "SS": "SS | ë¯¸ì‚¬ìš© ìƒˆìƒí’ˆ",
    "S":  "S | ì „ì‹œê¸‰(FT+ë¯¸ì„¸ ì‚¬ìš©ê°)",
    "A+": "A+ | ì¡°ê¸ˆ ì‚¬ìš©ê°",
    "A":  "A | ì‚¬ìš©ê° ìˆì§€ë§Œ ê´€ë¦¬ë¨",
    "B":  "B | ì‚¬ìš©ê° ë§ì´ ë³´ì„(ê°€ì„±ë¹„)",
    "X":  "X | íŒë§¤ë¶ˆê°€/ë¦¬í¼ í•„ìš”"
  },

  codes: ["FT","SCR","CHP","PEL","CRK","RUS","WOB","BRK","STN","FAD","PIL","TEA","SAG","WAR","MIS","REP"],
  exposure: ["Primary","Secondary","Hidden"],
  visibility: ["L1","L2","L3"],

  // ì»·(ìš´ì˜í•˜ë‹¤ê°€ ìˆ«ìë§Œ ë°”ê¾¸ë©´ ë¨)
  S_PRIMARY_L1_MAX: 2,
  APLUS_PRIMARY_L2_MAX: 1,
  APLUS_PRIMARY_L1_MAX: 6,
  A_PRIMARY_L2_MAX: 3,
  A_PRIMARY_L1_MAX: 10,

  // ì˜¤ì—¼(Primary ë‹¨ì¼) ìƒí•œ
  S_PRIMARY_STN_MAX_CM2: 0,
  APLUS_PRIMARY_STN_MAX_CM2: 1,
  A_PRIMARY_STN_MAX_CM2: 5,
  B_PRIMARY_STN_MAX_CM2: 20,

  photoShots: [
    "ì •ë©´", "í›„ë©´", "ì¢Œì¸¡", "ìš°ì¸¡", "ìƒë‹¨", "í•˜ë‹¨",
    "ì½”ë„ˆ1", "ì½”ë„ˆ2", "ì½”ë„ˆ3", "ì½”ë„ˆ4",
    "ë¼ë²¨/ì‹œë¦¬ì–¼", "êµ¬ì„±í’ˆ ì „ì²´",
    "ê²°í•¨1(í´ë¡œì¦ˆì—…)", "ê²°í•¨2(í´ë¡œì¦ˆì—…)", "ê²°í•¨3(í´ë¡œì¦ˆì—…)", "ê²°í•¨4(í´ë¡œì¦ˆì—…)",
    "í‘œë©´(ì‚¬ì„ ê´‘)", "ì›ë‹¨/ê°€ì£½(ê·¼ì ‘)", "í•˜ë¶€/í”„ë ˆì„", "í¬ì¥/ë°•ìŠ¤"
  ]
};

const $ = (id) => document.getElementById(id);

const toast = (msg) => {
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=> t.style.display="none", 1600);
};

function uuid(){
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now();
}

let state = { items: [], selectedId: null };

function loadState(){
  // 1) ìƒˆ í‚¤ ë¨¼ì €
  let raw = localStorage.getItem(CONFIG.storageKey);

  // 2) í˜¹ì‹œ ì˜ˆì „ í‚¤(ì´ì „ ë²„ì „)ë¡œ ì €ì¥í•œ ê²Œ ìˆìœ¼ë©´ ê°€ì ¸ì˜¤ê¸°(ë§ˆì´ê·¸ë ˆì´ì…˜)
  if(!raw){
    const legacy = localStorage.getItem("fullty_inspector_v1");
    if(legacy){
      raw = legacy;
      // ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ìƒˆ í‚¤ë¡œ ì €ì¥
      try{
        const obj = JSON.parse(legacy);
        state = normalizeState(obj);
        saveState();
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(state));
        toast("ì´ì „ ë°ì´í„° ë¶ˆëŸ¬ì˜´(ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ)");
        return;
      }catch(e){
        // ignore
      }
    }
  }

  if(raw){
    try{
      state = normalizeState(JSON.parse(raw));
    }catch(e){
      state = { items: [], selectedId: null };
    }
  }else{
    state = { items: [], selectedId: null };
  }
}

function normalizeState(obj){
  const base = obj && obj.items ? obj : { items: [], selectedId: null };
  base.items = (base.items || []).map(it=>{
    // ì´ì „ì— B+ê°€ ìˆì—ˆë‹¤ë©´ Aë¡œ í¡ìˆ˜
    if(it.grade === "B+") it.grade = "A";
    if(it.grade === "A+") it.grade = "A+";
    // gradeê°€ ì—†ìœ¼ë©´ "-"
    if(!it.grade) it.grade = "-";
    // photos ê¸¸ì´ ë³´ì •
    if(!Array.isArray(it.photos) || it.photos.length !== CONFIG.photoShots.length){
      it.photos = CONFIG.photoShots.map(()=>false);
    }
    // defects ë³´ì •
    if(!Array.isArray(it.defects)) it.defects = [];
    // í•„ë“œ ë³´ì •
    it.id = it.id || uuid();
    it.item_id = it.item_id || "";
    it.status = it.status || "draft";
    it.name = it.name || "";
    it.category = it.category || "";
    it.price = it.price || "";
    it.badges = it.badges || "";
    it.album_link = it.album_link || "";
    it.gate_x = !!it.gate_x;
    it.gate_reason = it.gate_reason || "";
    it.simple_content = it.simple_content || "";
    it.content_html = it.content_html || "";
    it.notes = it.notes || "";
    it.created_at = it.created_at || Date.now();
    it.updated_at = it.updated_at || Date.now();
    it.wear_label = it.wear_label || "-";
    return it;
  });

  // ì„ íƒê°’ ë³´ì •
  if(base.selectedId && !base.items.some(x=>x.id===base.selectedId)){
    base.selectedId = base.items[0]?.id || null;
  }
  return base;
}

function saveState(){
  localStorage.setItem(CONFIG.storageKey, JSON.stringify(state));
}

function todayId(){
  const d = new Date();
  const yy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const prefix = `${yy}${mm}${dd}`;
  const count = state.items.filter(it => (it.item_id||"").startsWith(prefix)).length + 1;
  return `${prefix}-${String(count).padStart(3,"0")}`;
}

function defaultItem(){
  return {
    id: uuid(),
    item_id: todayId(),
    status: "draft",
    name: "",
    category: "",
    price: "",
    badges: "",
    album_link: "",
    gate_x: false,
    gate_reason: "",
    grade: "-",
    wear_label: "-",
    simple_content: "",
    content_html: "",
    notes: "",
    defects: [],
    photos: CONFIG.photoShots.map(()=>false),
    created_at: Date.now(),
    updated_at: Date.now()
  };
}

/* ====== Scoring / Logic ====== */
function aggregate(defects){
  let primaryL1=0, primaryL2=0, primaryL3=0;
  let primaryStnMax=0;
  let wearCodes=0;
  let totalCount=0;

  defects.forEach(d=>{
    const exp = String(d.exposure||"").trim();
    const vis = String(d.visibility||"").trim();
    const code = String(d.code||"").trim().toUpperCase();
    const cnt = parseInt(d.count||1,10) || 1;
    const area = parseFloat(d.area_cm2||0) || 0;

    totalCount += cnt;

    if(["WAR","PIL","SAG","FAD"].includes(code)) wearCodes += cnt;

    if(exp === "Primary"){
      if(vis==="L1") primaryL1 += cnt;
      if(vis==="L2") primaryL2 += cnt;
      if(vis==="L3") primaryL3 += cnt;
      if(code==="STN") primaryStnMax = Math.max(primaryStnMax, area);
    }
  });

  return { primaryL1, primaryL2, primaryL3, primaryStnMax, wearCodes, totalCount };
}

function wearIndex(defects){
  let score=0;
  defects.forEach(d=>{
    const code = String(d.code||"").toUpperCase();
    const vis = String(d.visibility||"");
    const extra = String(d.extra||"").trim();

    if(code==="WAR" || code==="FAD"){
      score += (vis==="L1"?1:vis==="L2"?2:vis==="L3"?3:0);
    }
    if(code==="SAG"){
      const mm = parseFloat(extra||"0") || 0;
      score += (mm<=5?1:mm<=15?2:3);
    }
    if(code==="PIL"){
      const lvl = parseInt(extra||"5",10);
      // 5=0ì , 4=1ì , 3=2ì , 2=3ì , 1=4ì 
      score += Math.max(0, 5 - (isNaN(lvl)?5:lvl));
    }
  });

  if(score<=1) return 0;
  if(score<=3) return 1;
  if(score<=6) return 2;
  return 3;
}

function wearLabel(i){
  return i===0?"ë§¤ìš° ë‚®ìŒ":i===1?"ë‚®ìŒ":i===2?"ë³´í†µ":"ë†’ìŒ";
}

function gradeSummary(grade){
  switch(grade){
    case "SS": return "ë¯¸ì‚¬ìš© ìƒˆìƒí’ˆ ì»¨ë””ì…˜ì…ë‹ˆë‹¤. (ì‚¬ìš©ê°/ê²°í•¨ ê¸°ë¡ ì—†ìŒ)";
    case "S":  return "ì „ì‹œê¸‰ ì»¨ë””ì…˜ì´ë©° FT(íŒ©í† ë¦¬ í†¨ëŸ¬ëŸ°ìŠ¤)ì™€ ê°€ê¹Œì´ì—ì„œë§Œ ë³´ì¼ ìˆ˜ ìˆëŠ” ë¯¸ì„¸ ì‚¬ìš©ê°ì´ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
    case "A+": return "ì‚¬ìš©ê°ì´ ì•½ê°„ ìˆìœ¼ë©°, ê°€ê¹Œì´ì—ì„œ í™•ì¸ë˜ëŠ” í”ì ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
    case "A":  return "ì‚¬ìš©ê°ì´ ìˆìœ¼ë‚˜ ê´€ë¦¬ëœ ì»¨ë””ì…˜ì…ë‹ˆë‹¤.";
    case "B":  return "ì‚¬ìš©ê°ì´ ë§ì´ ë³´ì´ëŠ” í¸ì´ë©° ê°€ì„±ë¹„ë¥¼ ì¤‘ì‹œí•˜ëŠ” ë¶„ê»˜ ì¶”ì²œí•©ë‹ˆë‹¤.";
    case "X":  return "íŒë§¤ ì „ ë¦¬í¼/ì¬ê²€ìˆ˜ê°€ í•„ìš”í•˜ê±°ë‚˜ íŒë§¤ê°€ ì–´ë ¤ìš´ ìƒíƒœì…ë‹ˆë‹¤.";
    default:   return "";
  }
}

function evaluate(item){
  if(item.gate_x){
    return { grade:"X", wearI:3, note:item.gate_reason || "ê²Œì´íŠ¸ ì²˜ë¦¬" };
  }

  const agg = aggregate(item.defects);
  const wearI = wearIndex(item.defects);

  // ìº¡: Primary L3ê°€ ìˆìœ¼ë©´ ìµœëŒ€ B
  const hasPrimaryL3 = agg.primaryL3 > 0;

  // SS: "ë¯¸ì‚¬ìš© ìƒˆìƒí’ˆ" = ê²°í•¨ ê¸°ë¡ 0
  if(agg.totalCount === 0){
    return { grade:"SS", wearI:0 };
  }

  // S: ì „ì‹œê¸‰(FT+ë¯¸ì„¸ ì‚¬ìš©ê°) = Primary L2/L3 ì—†ìŒ, Primary L1 ì†ŒëŸ‰, ì˜¤ì—¼ 0, ì‚¬ìš©ê° ì§€ìˆ˜ ë‚®ìŒ
  const isS =
    agg.primaryL2 === 0 &&
    agg.primaryL3 === 0 &&
    agg.primaryL1 <= CONFIG.S_PRIMARY_L1_MAX &&
    agg.primaryStnMax <= CONFIG.S_PRIMARY_STN_MAX_CM2 &&
    wearI <= 1;
  if(isS) return { grade:"S", wearI };

  // A+: ì¡°ê¸ˆ ì‚¬ìš©ê°
  const isAPlus =
    agg.primaryL3 === 0 &&
    agg.primaryL2 <= CONFIG.APLUS_PRIMARY_L2_MAX &&
    agg.primaryL1 <= CONFIG.APLUS_PRIMARY_L1_MAX &&
    agg.primaryStnMax <= CONFIG.APLUS_PRIMARY_STN_MAX_CM2;
  if(isAPlus) return { grade:"A+", wearI };

  // A: ì‚¬ìš©ê° ìˆì§€ë§Œ ê´€ë¦¬ëœ ìƒíƒœ
  const isA =
    agg.primaryL3 === 0 &&
    agg.primaryL2 <= CONFIG.A_PRIMARY_L2_MAX &&
    agg.primaryL1 <= CONFIG.A_PRIMARY_L1_MAX &&
    agg.primaryStnMax <= CONFIG.A_PRIMARY_STN_MAX_CM2;
  if(isA) return { grade:"A", wearI };

  // B: ì‚¬ìš©ê° ë§ì´ ë³´ì„(ê°€ì„±ë¹„)
  // ë‹¨, Primary ë‹¨ì¼ ì˜¤ì—¼ì´ 20cmÂ² ì´ˆê³¼ë©´ X(ë¦¬í¼/ì¬ê²€ìˆ˜ ê¶Œì¥)
  if(agg.primaryStnMax > CONFIG.B_PRIMARY_STN_MAX_CM2){
    return { grade:"X", wearI:3, note:`Primary ì˜¤ì—¼ ${agg.primaryStnMax}cmÂ² > ${CONFIG.B_PRIMARY_STN_MAX_CM2}cmÂ²` };
  }

  if(hasPrimaryL3){
    return { grade:"B", wearI:3, note:"Primary L3ë¡œ B ìº¡" };
  }
  return { grade:"B", wearI };
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function escapeAttr(s){
  return String(s||"").replaceAll('"',"%22");
}

function buildOutputs(item, grade, wearI, note){
  const wl = wearLabel(wearI);
  const badges = (item.badges||"").trim();
  const link = (item.album_link||"").trim();

  const simple =
    `[${grade}] ${CONFIG.gradeLabels[grade] || grade} / ì‚¬ìš©ê°: ${wl}` +
    (badges ? ` / ë°°ì§€: ${badges}` : "") +
    (link ? ` / ì‚¬ì§„: ${link}` : "");

  const lines = item.defects
    .filter(d=>d.code)
    .map(d=>{
      const exp = d.exposure || "";
      const vis = d.visibility || "";
      const code = String(d.code||"").toUpperCase();
      const cnt = parseInt(d.count||1,10) || 1;
      const mm = parseFloat(d.size_mm||0) || 0;
      const cm2 = parseFloat(d.area_cm2||0) || 0;
      const extra = String(d.extra||"").trim();

      let add = "";
      if(code==="STN" && cm2) add = ` (ì˜¤ì—¼ ${cm2}cmÂ²)`;
      else if(mm) add = ` (${mm}mm)`;
      if(extra && (code==="PIL"||code==="SAG")) add += ` [${code==="PIL"?"í•„ë§":"êº¼ì§"}:${extra}]`;

      return `- ${exp}/${vis} ${code} x${cnt}${add}`;
    });

  const html =
`<div style="line-height:1.7; color:#000;">
  <h2>ì»¨ë””ì…˜</h2>
  <p><b>${escapeHtml(CONFIG.gradeLabels[grade] || grade)}</b><br/>
     ì‚¬ìš©ê°: <b>${escapeHtml(wl)}</b>
     ${badges?`<br/>ë°°ì§€: <b>${escapeHtml(badges)}</b>`:""}
     ${link?`<br/>ì‚¬ì§„ ë§í¬: <a href="${escapeAttr(link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(link)}</a>`:""}
  </p>
  <h3>ìš”ì•½</h3>
  <p>${escapeHtml(gradeSummary(grade))}</p>
  ${note?`<p style="color:rgba(0,0,0,.65);">ê²€ìˆ˜ ë…¸íŠ¸: ${escapeHtml(note)}</p>`:""}
  <h3>ê²°í•¨/ì‚¬ìš©ê° ê³ ì§€</h3>
  ${lines.length?`<pre style="white-space:pre-wrap; background:rgba(0,0,0,.03); border:1px solid rgba(0,0,0,.15); padding:10px; border-radius:12px;">${escapeHtml(lines.join("\\n"))}</pre>`:"<p>ê¸°ë¡ëœ ê²°í•¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>"}
  <hr style="border:0; border-top:1px solid rgba(0,0,0,.15);"/>
  <p style="color:rgba(0,0,0,.55); font-size:12px;">í‘œì¤€: ${escapeHtml(CONFIG.version)}</p>
</div>`;

  return { simple, html, wearLabel: wl };
}

/* ====== UI helpers ====== */
function renderPhotoChecks(item){
  const wrap = $("photoChecks");
  wrap.innerHTML = "";
  CONFIG.photoShots.forEach((label, idx)=>{
    const el = document.createElement("label");
    el.className = "check";
    el.innerHTML = `<input type="checkbox" ${item.photos[idx] ? "checked" : ""}/> <span>${escapeHtml(label)}</span>`;
    el.querySelector("input").onchange = (e)=>{
      item.photos[idx] = e.target.checked;
      item.updated_at = Date.now();
      saveState();
    };
    wrap.appendChild(el);
  });
}

function addDefRow(rowData={}){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><select class="exposure"></select></td>
    <td><select class="visibility"></select></td>
    <td><select class="code"></select></td>
    <td><input class="size_mm" inputmode="numeric" placeholder="0"/></td>
    <td><input class="area_cm2" inputmode="decimal" placeholder="0"/></td>
    <td><input class="count" inputmode="numeric" placeholder="1"/></td>
    <td><input class="extra" placeholder="PIL:1~5 / SAG:mm"/></td>
    <td class="right"><button class="ghost del">ì‚­ì œ</button></td>
  `;

  const ex = tr.querySelector(".exposure");
  CONFIG.exposure.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; ex.appendChild(o); });
  const vi = tr.querySelector(".visibility");
  CONFIG.visibility.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; vi.appendChild(o); });
  const co = tr.querySelector(".code");
  CONFIG.codes.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; co.appendChild(o); });

  ex.value = rowData.exposure || "Primary";
  vi.value = rowData.visibility || "L1";
  co.value = rowData.code || "SCR";
  tr.querySelector(".size_mm").value = rowData.size_mm ?? "";
  tr.querySelector(".area_cm2").value = rowData.area_cm2 ?? "";
  tr.querySelector(".count").value = rowData.count ?? 1;
  tr.querySelector(".extra").value = rowData.extra ?? "";

  tr.querySelector(".del").onclick = ()=>{ tr.remove(); syncDefectsFromUI(); };

  ["change","input"].forEach(ev=>{
    tr.addEventListener(ev, ()=>syncDefectsFromUI());
  });

  $("defBody").appendChild(tr);
}

function syncDefectsFromUI(){
  const item = getSelectedItem();
  if(!item) return;

  const rows = Array.from($("defBody").querySelectorAll("tr"));
  item.defects = rows.map(tr=>({
    exposure: tr.querySelector(".exposure").value,
    visibility: tr.querySelector(".visibility").value,
    code: tr.querySelector(".code").value,
    size_mm: tr.querySelector(".size_mm").value,
    area_cm2: tr.querySelector(".area_cm2").value,
    count: tr.querySelector(".count").value,
    extra: tr.querySelector(".extra").value
  }));

  item.updated_at = Date.now();
  saveState();
}

function getSelectedItem(){
  return state.items.find(it=>it.id===state.selectedId) || null;
}

function selectItem(id){
  state.selectedId = id;
  saveState();
  fillForm(getSelectedItem());
}

function fillForm(item){
  if(!item){
    $("selName").textContent = "ì—†ìŒ";
    return;
  }
  $("selName").textContent = item.name || item.item_id || "ì„ íƒë¨";

  $("item_id").value = item.item_id || "";
  $("status").value = item.status || "draft";
  $("name").value = item.name || "";
  $("category").value = item.category || "";
  $("price").value = item.price || "";
  $("badges").value = item.badges || "";
  $("album_link").value = item.album_link || "";
  $("gate_x").value = String(!!item.gate_x);
  $("gate_reason").value = item.gate_reason || "";

  $("grade").textContent = item.grade || "-";
  $("wear_label").textContent = item.wear_label || "-";
  $("simple_content").value = item.simple_content || "";
  $("content_html").value = item.content_html || "";
  $("notes").value = item.notes || "";

  // defects
  $("defBody").innerHTML = "";
  (item.defects||[]).forEach(d=>addDefRow(d));

  // photo checks
  renderPhotoChecks(item);
}

function updateItemFromForm(){
  const item = getSelectedItem();
  if(!item) return null;

  item.item_id = $("item_id").value.trim() || item.item_id || todayId();
  item.status = $("status").value;
  item.name = $("name").value.trim();
  item.category = $("category").value.trim();
  item.price = $("price").value.trim();
  item.badges = $("badges").value.trim();
  item.album_link = $("album_link").value.trim();
  item.gate_x = $("gate_x").value === "true";
  item.gate_reason = $("gate_reason").value.trim();
  item.notes = $("notes").value;

  item.updated_at = Date.now();
  syncDefectsFromUI();

  saveState();
  renderList();

  return item;
}

function calcAndFill(){
  const item = updateItemFromForm();
  if(!item) return;

  const res = evaluate(item);
  const out = buildOutputs(item, res.grade, res.wearI, res.note);

  item.grade = res.grade;
  item.wear_label = out.wearLabel;
  item.simple_content = out.simple;
  item.content_html = out.html;
  item.updated_at = Date.now();

  saveState();
  fillForm(item);
  renderList();
  toast(`ìƒì„± ì™„ë£Œ: ${item.grade} / ì‚¬ìš©ê° ${item.wear_label}`);
}

function renderList(){
  const q = $("q").value.trim().toLowerCase();
  const fg = $("filterGrade").value;
  const sortBy = $("sortBy").value;

  let items = [...state.items];

  if(q){
    items = items.filter(it =>
      (it.name||"").toLowerCase().includes(q) ||
      (it.item_id||"").toLowerCase().includes(q) ||
      (it.grade||"").toLowerCase().includes(q)
    );
  }
  if(fg){
    items = items.filter(it => it.grade === fg);
  }

  items.sort((a,b)=>{
    if(sortBy==="new") return (b.updated_at||0) - (a.updated_at||0);
    if(sortBy==="old") return (a.updated_at||0) - (b.updated_at||0);
    return String(a.name||"").localeCompare(String(b.name||""),"ko");
  });

  const el = $("list");
  el.innerHTML = "";

  items.forEach(it=>{
    const div = document.createElement("div");
    div.className = "item";
    div.onclick = ()=>selectItem(it.id);

    div.innerHTML = `
      <div class="top">
        <div><b>${escapeHtml(it.name || "(ìƒí’ˆëª… ì—†ìŒ)")}</b></div>
        <span class="pill">ë“±ê¸‰ <b>${escapeHtml(it.grade || "-")}</b></span>
      </div>
      <div class="meta">
        ID: <span class="kbd">${escapeHtml(it.item_id || "-")}</span><br/>
        ${escapeHtml(it.category || "")} Â· ì‚¬ìš©ê°: ${escapeHtml(it.wear_label || "-")} Â· ${it.status==="final" ? "âœ…ì™„ë£Œ" : "ğŸ“ì‘ì„±ì¤‘"}
      </div>
    `;
    el.appendChild(div);
  });

  if(!items.length){
    el.innerHTML = `<div class="muted">ëª©ë¡ì´ ë¹„ì–´ìˆì–´ìš”. <span class="kbd">+ ìƒˆ ê²€ìˆ˜</span>ë¡œ ì‹œì‘í•˜ì„¸ìš”.</div>`;
  }
}

function newItem(){
  const it = defaultItem();
  state.items.unshift(it);
  state.selectedId = it.id;
  saveState();
  renderList();
  fillForm(it);
  toast("ìƒˆ ê²€ìˆ˜ ìƒì„±");
}

function deleteSelected(){
  const id = state.selectedId;
  if(!id) return;

  const idx = state.items.findIndex(it=>it.id===id);
  if(idx >= 0){
    const name = state.items[idx].name || state.items[idx].item_id;
    state.items.splice(idx, 1);
    state.selectedId = state.items[0]?.id || null;
    saveState();
    renderList();
    fillForm(getSelectedItem());
    toast(`ì‚­ì œ: ${name}`);
  }
}

function exportCSV(){
  const cols = ["item_id","status","name","category","price","badges","album_link","gate_x","gate_reason","grade","wear_label","updated_at"];
  const rows = [cols.join(",")];

  state.items.forEach(it=>{
    const r = cols.map(c=>{
      let v = it[c];
      if(c==="updated_at") v = new Date(it.updated_at||0).toISOString();
      const s = String(v ?? "").replaceAll('"','""');
      return `"${s}"`;
    }).join(",");
    rows.push(r);
  });

  const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
  downloadBlob(blob, `fullty_inspector_${Date.now()}.csv`);
}

function backupJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  downloadBlob(blob, `fullty_inspector_backup_${Date.now()}.json`);
}

function restoreJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      if(!obj || !obj.items) throw new Error("í˜•ì‹ ì˜¤ë¥˜");
      state = normalizeState(obj);
      saveState();
      renderList();
      fillForm(getSelectedItem());
      toast("ë³µì› ì™„ë£Œ");
    }catch(e){
      alert("ë³µì› ì‹¤íŒ¨: " + e.message);
    }
  };
  reader.readAsText(file);
}

function wipeAll(){
  if(!confirm("ì •ë§ ì „ì²´ ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”? (ë³µêµ¬ ë¶ˆê°€)")) return;
  state = { items: [], selectedId: null };
  saveState();
  renderList();
  fillForm(null);
  toast("ì „ì²´ ì‚­ì œ");
}

function downloadBlob(blob, filename){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
}

function copyText(value){
  navigator.clipboard.writeText(value)
    .then(()=>toast("ë³µì‚¬ë¨"))
    .catch(()=>toast("ë³µì‚¬ ì‹¤íŒ¨"));
}

/* Data Modal */
function openDataModal(){
  $("dataDump").value = JSON.stringify(state, null, 2);
  $("dataModal").style.display = "flex";
}
function closeDataModal(){
  $("dataModal").style.display = "none";
}

/* Init */
function init(){
  loadState();
  renderList();

  if(state.selectedId){
    fillForm(getSelectedItem());
  }else if(state.items[0]){
    state.selectedId = state.items[0].id;
    saveState();
    fillForm(getSelectedItem());
  }else{
    fillForm(null);
  }

  $("btnNew").onclick = newItem;
  $("btnCalc").onclick = calcAndFill;
  $("btnSave").onclick = ()=>{ updateItemFromForm(); toast("ì €ì¥ë¨"); };
  $("btnDelete").onclick = deleteSelected;

  $("btnAddDef").onclick = ()=>{ addDefRow(); syncDefectsFromUI(); };
  $("btnClearDef").onclick = ()=>{ $("defBody").innerHTML=""; syncDefectsFromUI(); };

  $("btnCopySimple").onclick = ()=>copyText($("simple_content").value || "");
  $("btnCopyHtml").onclick = ()=>copyText($("content_html").value || "");

  $("q").oninput = renderList;
  $("filterGrade").onchange = renderList;
  $("sortBy").onchange = renderList;

  $("btnCSV").onclick = exportCSV;

  $("btnBackup").onclick = backupJSON;
  $("btnRestore").onclick = ()=>$("restoreFile").click();
  $("restoreFile").onchange = (e)=>{ const f=e.target.files?.[0]; if(f) restoreJSON(f); e.target.value=""; };

  $("btnWipe").onclick = wipeAll;

  // Data view modal
  $("btnViewData").onclick = openDataModal;
  $("btnCloseData").onclick = closeDataModal;
  $("btnCopyData").onclick = ()=>copyText($("dataDump").value || "");
  $("dataModal").addEventListener("click", (e)=>{ if(e.target.id==="dataModal") closeDataModal(); });

  // auto-save
  ["item_id","status","name","category","price","badges","album_link","gate_x","gate_reason","notes"].forEach(id=>{
    $(id).addEventListener("change", ()=>updateItemFromForm());
    $(id).addEventListener("blur", ()=>updateItemFromForm());
  });
}

init();
</script>
</body>
</html>
