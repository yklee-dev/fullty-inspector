<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fullty Inspector (FCS v1.3)</title>
  <style>
    :root { --bg:#0b0d12; --card:#121726; --muted:#8b93a7; --text:#e9ecf5; --line:#222a40; --btn:#2b61ff; --btn2:#2a3147; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; background:linear-gradient(180deg,#070910,#0b0d12); color:var(--text); }
    header { position:sticky; top:0; background:rgba(7,9,16,.85); backdrop-filter: blur(8px); border-bottom:1px solid var(--line); z-index:10; }
    header .wrap { display:flex; gap:10px; align-items:center; justify-content:space-between; padding:12px 14px; max-width:1100px; margin:0 auto; }
    .brand { display:flex; gap:10px; align-items:center; }
    .dot { width:10px; height:10px; border-radius:50%; background:var(--btn); box-shadow:0 0 14px rgba(43,97,255,.8); }
    .brand b { font-size:14px; letter-spacing:.2px; }
    .brand span { color:var(--muted); font-size:12px; }
    main { max-width:1100px; margin:0 auto; padding:14px; display:grid; gap:12px; grid-template-columns: 1fr; }
    @media(min-width: 980px){ main { grid-template-columns: 360px 1fr; align-items:start; } }
    .card { background:rgba(18,23,38,.92); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow: 0 10px 40px rgba(0,0,0,.35); }
    .card h2 { margin:0 0 8px; font-size:14px; }
    .row { display:grid; grid-template-columns: 1fr; gap:10px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    label { font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input, select, textarea {
      width:100%; box-sizing:border-box;
      background:#0e1220; border:1px solid #27304a; color:var(--text);
      padding:10px 10px; border-radius:10px; outline:none;
    }
    textarea { min-height: 74px; resize: vertical; }
    .btns { display:flex; flex-wrap:wrap; gap:8px; }
    button {
      border:0; border-radius:10px; padding:10px 12px; cursor:pointer;
      color:var(--text); background:var(--btn2);
    }
    button.primary { background:var(--btn); }
    button.danger { background:#ff3b5c; }
    button.ghost { background:transparent; border:1px solid #2b3552; }
    .pill { display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background:#0e1220; border:1px solid #27304a; font-size:12px; color:var(--muted); }
    .pill b { color:var(--text); font-weight:700; }
    .list { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .item { border:1px solid #27304a; background:#0e1220; border-radius:12px; padding:10px; cursor:pointer; }
    .item:hover { border-color:#3a4770; }
    .item .top { display:flex; justify-content:space-between; gap:10px; }
    .item .meta { color:var(--muted); font-size:12px; margin-top:6px; line-height:1.35; }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { border-bottom:1px solid #223055; padding:8px 6px; font-size:12px; vertical-align:top; }
    .table th { color:var(--muted); text-align:left; font-weight:600; }
    .table td input, .table td select { padding:8px; border-radius:10px; }
    .muted { color:var(--muted); font-size:12px; line-height:1.5; }
    .split { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .right { text-align:right; }
    .hr { height:1px; background:#223055; margin:10px 0; }
    .toast { position: fixed; bottom:14px; left: 50%; transform: translateX(-50%); background:#0e1220; border:1px solid #2b3552; padding:10px 12px; border-radius:12px; color:var(--text); display:none; max-width: 90vw; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 11px; background:#0b0f1d; border:1px solid #27304a; padding:2px 6px; border-radius:8px; color:#b9c2da; }
    .badges { display:flex; gap:8px; flex-wrap:wrap; }
    .checkgrid { display:grid; grid-template-columns: 1fr 1fr; gap:6px; }
    @media(min-width: 520px){ .checkgrid { grid-template-columns: 1fr 1fr 1fr; } }
    .check { display:flex; gap:8px; align-items:center; font-size:12px; color:#c9d0e4; background:#0e1220; border:1px solid #27304a; border-radius:10px; padding:8px; }
    .check input { width:auto; }
    pre { white-space: pre-wrap; word-break: break-word; background:#0b0f1d; border:1px solid #27304a; padding:10px; border-radius:12px; margin:0; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <b>Fullty Inspector</b>
        <div><span>FCS v1.3 Â· ë“±ê¸‰ ìë™ ì‚°ì¶œ(ë¡œì»¬ ì €ì¥)</span></div>
      </div>
    </div>
    <div class="split">
      <span class="pill">ì„ íƒ: <b id="selName">ì—†ìŒ</b></span>
      <button class="ghost" id="btnBackup">JSON ë°±ì—…</button>
      <button class="ghost" id="btnRestore">ë³µì›</button>
      <input id="restoreFile" type="file" accept="application/json" style="display:none" />
      <button class="danger" id="btnWipe">ì „ì²´ì‚­ì œ</button>
    </div>
  </div>
</header>

<main>
  <!-- LEFT: LIST -->
  <section class="card">
    <h2>ê²€ìˆ˜ ëª©ë¡</h2>
    <div class="row">
      <div>
        <label>ê²€ìƒ‰</label>
        <input id="q" placeholder="ìƒí’ˆëª…/ID/ë“±ê¸‰ìœ¼ë¡œ ê²€ìƒ‰" />
      </div>
      <div class="grid2">
        <div>
          <label>í•„í„°(ë“±ê¸‰)</label>
          <select id="filterGrade">
            <option value="">ì „ì²´</option>
            <option>S</option><option>A+</option><option>A</option><option>B+</option><option>B</option><option>X</option>
          </select>
        </div>
        <div>
          <label>ì •ë ¬</label>
          <select id="sortBy">
            <option value="new">ìµœì‹ </option>
            <option value="old">ì˜¤ë˜ëœ</option>
            <option value="name">ìƒí’ˆëª…</option>
          </select>
        </div>
      </div>
      <div class="btns">
        <button class="primary" id="btnNew">+ ìƒˆ ê²€ìˆ˜</button>
        <button id="btnCSV">CSV ë‚´ë³´ë‚´ê¸°</button>
      </div>
      <div class="muted">
        âš ï¸ ë°ì´í„°ëŠ” ì´ ê¸°ê¸° ë¸Œë¼ìš°ì €ì— ì €ì¥ë¼ìš”. ì£¼ 1íšŒ <span class="kbd">JSON ë°±ì—…</span> ì¶”ì²œ.
      </div>
    </div>
    <div class="hr"></div>
    <div class="list" id="list"></div>
  </section>

  <!-- RIGHT: EDITOR -->
  <section class="card">
    <h2>ê²€ìˆ˜ ì…ë ¥</h2>

    <div class="row">
      <div class="grid2">
        <div>
          <label>ìƒí’ˆ ID</label>
          <input id="item_id" placeholder="ìë™ ìƒì„± ë˜ëŠ” ì…ë ¥" />
        </div>
        <div>
          <label>ê²€ìˆ˜ ìƒíƒœ</label>
          <select id="status">
            <option value="draft">draft (ì‘ì„±ì¤‘)</option>
            <option value="final">final (ì™„ë£Œ)</option>
          </select>
        </div>
      </div>

      <div>
        <label>ìƒí’ˆëª…</label>
        <input id="name" placeholder="ì˜ˆ: USM Haller Sideboard (í™”ì´íŠ¸)" />
      </div>

      <div class="grid2">
        <div>
          <label>ì¹´í…Œê³ ë¦¬</label>
          <input id="category" placeholder="ì˜ˆ: í…Œì´ë¸” / ì¡°ëª… / ì†ŒíŒŒ" />
        </div>
        <div>
          <label>ê°€ê²©(ì„ íƒ)</label>
          <input id="price" placeholder="ì˜ˆ: 1,290,000" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>ë°°ì§€(ì½¤ë§ˆ)</label>
          <input id="badges" placeholder="BOX,TAG,CLEANING,VINTAGE,REFURB" />
        </div>
        <div>
          <label>ì‚¬ì§„ ì•¨ë²”/í´ë” ë§í¬(ì„ íƒ)</label>
          <input id="album_link" placeholder="êµ¬ê¸€ë“œë¼ì´ë¸Œ/ì•¨ë²” ë§í¬" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>íŒë§¤ë¶ˆê°€(X)ë¡œ ì²˜ë¦¬ (ê²Œì´íŠ¸)</label>
          <select id="gate_x">
            <option value="false">ì•„ë‹ˆì˜¤</option>
            <option value="true">ì˜ˆ (ë¦¬í¼/ë°˜ë ¤)</option>
          </select>
        </div>
        <div>
          <label>ê²Œì´íŠ¸ ì‚¬ìœ (ì„ íƒ)</label>
          <input id="gate_reason" placeholder="ì˜ˆ: êµ¬ì¡° íŒŒì† / ì „ê¸° ë¶ˆëŸ‰ / ê³°íŒ¡ì´" />
        </div>
      </div>

      <div class="split">
        <span class="pill">ë“±ê¸‰: <b id="grade">-</b></span>
        <span class="pill">ì‚¬ìš©ê°: <b id="wear_label">-</b></span>
        <span class="pill">ê·œì¹™: <b>FCS v1.3</b></span>
      </div>

      <div class="btns">
        <button class="primary" id="btnCalc">ë“±ê¸‰/ë¬¸êµ¬ ìƒì„±</button>
        <button id="btnSave">ì €ì¥</button>
        <button class="danger" id="btnDelete">ì‚­ì œ</button>
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0;">ê²°í•¨ ì…ë ¥</h2>
      <div class="muted">
        ì…ë ¥ì€ <b>ì½”ë“œ + ë…¸ì¶œë©´ + ê°€ì‹œê±°ë¦¬ + í¬ê¸°/ë©´ì  + ê°œìˆ˜</b>ë¡œë§Œ. (ì£¼ê´€ ë¬¸ì¥ ìµœì†Œí™”)
      </div>

      <div style="overflow:auto;">
        <table class="table" id="defTable">
          <thead>
          <tr>
            <th>ë…¸ì¶œë©´</th>
            <th>ê°€ì‹œê±°ë¦¬</th>
            <th>ì½”ë“œ</th>
            <th>ê¸¸ì´(mm)</th>
            <th>ë©´ì (cmÂ²)</th>
            <th>ê°œìˆ˜</th>
            <th>ì¶”ê°€(í•„ë§1~5/êº¼ì§mm ë“±)</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="defBody"></tbody>
        </table>
      </div>
      <div class="btns" style="margin-top:8px;">
        <button id="btnAddDef">+ ê²°í•¨ ì¶”ê°€</button>
        <button class="ghost" id="btnClearDef">ê²°í•¨ ë¹„ìš°ê¸°</button>
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0;">ì‚¬ì§„ ì²´í¬ë¦¬ìŠ¤íŠ¸(20ì¥ ê¶Œì¥)</h2>
      <div class="muted">ì‚¬ì§„ì€ ì´ ì•±ì— ì €ì¥í•˜ì§€ ì•Šê³ , ì´¬ì˜ ì™„ë£Œ ì—¬ë¶€ë§Œ ì²´í¬í•´ìš”(ìš©ëŸ‰/ì†ë„ ì•ˆì •).</div>
      <div class="checkgrid" id="photoChecks"></div>

      <div class="hr"></div>

      <h2 style="margin-top:0;">ìë™ ìƒì„± ê²°ê³¼</h2>
      <div class="grid2">
        <div>
          <label>ìš”ì•½ë¬¸(ë³µë¶™ìš©)</label>
          <textarea id="simple_content" readonly></textarea>
          <div class="btns" style="margin-top:8px;">
            <button id="btnCopySimple">ìš”ì•½ ë³µì‚¬</button>
          </div>
        </div>
        <div>
          <label>ìƒì„¸ì„¤ëª… HTML(ë³µë¶™ìš©)</label>
          <textarea id="content_html" readonly></textarea>
          <div class="btns" style="margin-top:8px;">
            <button id="btnCopyHtml">HTML ë³µì‚¬</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <h2 style="margin-top:0;">ë©”ëª¨</h2>
      <textarea id="notes" placeholder="ê²€ìˆ˜ ë©”ëª¨ (CSìš©, ë‚´ë¶€ìš©)"></textarea>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<script>
/** =========================
 *  Fullty FCS v1.3 (no Imweb)
 *  Local-only app (localStorage)
 * ========================= */

const CONFIG = {
  version: "FCS v1.3",
  // í™•ì •ê°’
  BPLUS_PRIMARY_L2_MAX: 3,
  B_PRIMARY_STN_MAX_CM2: 20,

  // ìš´ì˜ê°’(ë„ˆê°€ ë°”ê¾¸ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ë§Œ ìˆ˜ì •)
  A_PRIMARY_L2_MAX: 2,
  APLUS_PRIMARY_L2_MAX: 0,
  APLUS_PRIMARY_L1_MAX: 3,
  A_PRIMARY_L1_MAX: 6,
  BPLUS_PRIMARY_STN_MAX_CM2: 5,
  A_PRIMARY_STN_MAX_CM2: 2,
  APLUS_PRIMARY_STN_MAX_CM2: 0,

  gradeLabels: {
    "S":  "S | ë¯¸ì‚¬ìš©/ì „ì‹œê¸‰(FT í¬í•¨)",
    "A+": "A+ | ì•½ê°„ì˜ ì‚¬ìš©ê°",
    "A":  "A | ê´œì°®ì€ ì‚¬ìš©ê°",
    "B+": "B+ | ì‚¬ìš©ê°",
    "B":  "B | ë§ì´ ë³´ì´ëŠ” ì‚¬ìš©ê°(ê°€ì„±ë¹„)",
    "X":  "X | íŒë§¤ë¶ˆê°€/ë¦¬í¼ í•„ìš”"
  },
  codes: ["FT","SCR","CHP","PEL","CRK","RUS","WOB","BRK","STN","FAD","PIL","TEA","SAG","WAR","MIS","REP"],
  exposure: ["Primary","Secondary","Hidden"],
  visibility: ["L1","L2","L3"],
  photoShots: [
    "ì •ë©´", "í›„ë©´", "ì¢Œì¸¡", "ìš°ì¸¡", "ìƒë‹¨", "í•˜ë‹¨",
    "ì½”ë„ˆ1", "ì½”ë„ˆ2", "ì½”ë„ˆ3", "ì½”ë„ˆ4",
    "ë¼ë²¨/ì‹œë¦¬ì–¼", "êµ¬ì„±í’ˆ ì „ì²´",
    "ê²°í•¨1(í´ë¡œì¦ˆì—…)", "ê²°í•¨2(í´ë¡œì¦ˆì—…)", "ê²°í•¨3(í´ë¡œì¦ˆì—…)", "ê²°í•¨4(í´ë¡œì¦ˆì—…)",
    "í‘œë©´(ì‚¬ì„ ê´‘)", "ì›ë‹¨/ê°€ì£½(ê·¼ì ‘)", "í•˜ë¶€/í”„ë ˆì„", "í¬ì¥/ë°•ìŠ¤"
  ]
};

const STORE_KEY = "fullty_inspector_v1";
let state = { items: [], selectedId: null };

const $ = (id) => document.getElementById(id);
const toast = (msg) => { const t=$("toast"); t.textContent=msg; t.style.display="block"; clearTimeout(toast._tm); toast._tm=setTimeout(()=>t.style.display="none",1600); };

function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(raw) state = JSON.parse(raw);
  }catch(e){}
  if(!state.items) state = { items: [], selectedId: null };
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

function todayId(){
  const d = new Date();
  const yy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const prefix = `${yy}${mm}${dd}`;
  const count = state.items.filter(it => (it.item_id||"").startsWith(prefix)).length + 1;
  return `${prefix}-${String(count).padStart(3,"0")}`;
}

function defaultItem(){
  return {
    id: crypto.randomUUID(),
    item_id: todayId(),
    status: "draft",
    name: "",
    category: "",
    price: "",
    badges: "",
    album_link: "",
    gate_x: false,
    gate_reason: "",
    grade: "-",
    wear_label: "-",
    simple_content: "",
    content_html: "",
    notes: "",
    defects: [],
    photos: CONFIG.photoShots.map(()=>false),
    created_at: Date.now(),
    updated_at: Date.now()
  };
}

function aggregate(defects){
  let primaryL1=0, primaryL2=0, primaryL3=0;
  let nonFT=0;
  let wearCodes=0;
  let primaryStnMax=0;

  defects.forEach(d=>{
    const exp = (d.exposure||"").trim();
    const vis = (d.visibility||"").trim();
    const code = (d.code||"").trim().toUpperCase();
    const cnt = parseInt(d.count||1,10) || 1;
    const area = parseFloat(d.area_cm2||0) || 0;

    if(code && code !== "FT") nonFT += cnt;
    if(["WAR","PIL","SAG","FAD"].includes(code)) wearCodes += cnt;

    if(exp === "Primary"){
      if(vis==="L1") primaryL1 += cnt;
      if(vis==="L2") primaryL2 += cnt;
      if(vis==="L3") primaryL3 += cnt;
      if(code==="STN") primaryStnMax = Math.max(primaryStnMax, area);
    }
  });

  return { primaryL1, primaryL2, primaryL3, nonFT, wearCodes, primaryStnMax };
}

function wearIndex(defects){
  let score=0;
  defects.forEach(d=>{
    const code=(d.code||"").toUpperCase();
    const vis=(d.visibility||"");
    const extra=(d.extra||"").trim();

    if(code==="WAR" || code==="FAD"){
      score += (vis==="L1"?1:vis==="L2"?2:vis==="L3"?3:0);
    }
    if(code==="SAG"){
      const mm = parseFloat(extra||"0") || 0;
      score += (mm<=5?1:mm<=15?2:3);
    }
    if(code==="PIL"){
      const lvl = parseInt(extra||"5",10);
      score += Math.max(0, 5 - (isNaN(lvl)?5:lvl));
    }
  });
  if(score<=1) return 0;
  if(score<=3) return 1;
  if(score<=6) return 2;
  return 3;
}
function wearLabel(i){ return i===0?"ë§¤ìš° ë‚®ìŒ":i===1?"ë‚®ìŒ":i===2?"ë³´í†µ":"ë†’ìŒ"; }

function gradeSummary(grade){
  switch(grade){
    case "S": return "ë¯¸ì‚¬ìš©/ì „ì‹œê¸‰ ì»¨ë””ì…˜ì´ë©° ì œì¡° ê³µì •ìƒ í—ˆìš© ë²”ìœ„(FT)ê°€ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
    case "A+": return "ê°€ê¹Œì´ì—ì„œë§Œ í™•ì¸ë˜ëŠ” ë¯¸ì„¸í•œ ì‚¬ìš©ê°ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
    case "A": return "ì¼ìƒì ì¸ ì‚¬ìš©ê°ì´ ìˆìœ¼ë‚˜ ì „ë°˜ì ìœ¼ë¡œ ê¹”ë”í•œ í¸ì…ë‹ˆë‹¤.";
    case "B+": return "ì‚¬ìš©ê°ì´ ë¶„ëª…í•˜ì§€ë§Œ ê´€ë¦¬ëœ ì»¨ë””ì…˜ì…ë‹ˆë‹¤.";
    case "B": return "ì‚¬ìš©ê°ì´ ë§ì´ ë³´ì´ëŠ” í¸ì´ë©° ê°€ì„±ë¹„ë¥¼ ì¤‘ì‹œí•˜ëŠ” ë¶„ê»˜ ì¶”ì²œí•©ë‹ˆë‹¤.";
    case "X": return "íŒë§¤ ì „ ë¦¬í¼/ì¬ê²€ìˆ˜ê°€ í•„ìš”í•˜ê±°ë‚˜ íŒë§¤ê°€ ì–´ë ¤ìš´ ìƒíƒœì…ë‹ˆë‹¤.";
    default: return "";
  }
}

function evaluate(item){
  if(item.gate_x) return { grade:"X", wearI:3, note:item.gate_reason || "ê²Œì´íŠ¸ ì²˜ë¦¬" };

  const agg = aggregate(item.defects);
  const wearI = wearIndex(item.defects);

  // ìº¡: Primary L3ê°€ ìˆìœ¼ë©´ ìµœëŒ€ B
  const hasPrimaryL3 = agg.primaryL3 > 0;

  // S: FT ì™¸ ê²°í•¨ 0 + ì‚¬ìš©ê° ì½”ë“œ 0 + Primary L2/L3 0
  const isS = (agg.nonFT===0 && agg.wearCodes===0 && agg.primaryL2===0 && agg.primaryL3===0);
  if(isS) return { grade:"S", wearI:0 };

  // A+: Primary L2 0, L3 0, Primary L1<=3, Primary STN 0
  const isAPlus =
    agg.primaryL2 <= CONFIG.APLUS_PRIMARY_L2_MAX &&
    agg.primaryL3 === 0 &&
    agg.primaryL1 <= CONFIG.APLUS_PRIMARY_L1_MAX &&
    agg.primaryStnMax <= CONFIG.APLUS_PRIMARY_STN_MAX_CM2;
  if(isAPlus) return { grade:"A+", wearI };

  // A: Primary L2<=2, L3 0, Primary L1<=6, Primary STN<=2
  const isA =
    agg.primaryL2 <= CONFIG.A_PRIMARY_L2_MAX &&
    agg.primaryL3 === 0 &&
    agg.primaryL1 <= CONFIG.A_PRIMARY_L1_MAX &&
    agg.primaryStnMax <= CONFIG.A_PRIMARY_STN_MAX_CM2;
  if(isA) return { grade:"A", wearI };

  // B+: Primary L2<=3(í™•ì •), L3 0, Primary STN<=5
  const isBPlus =
    agg.primaryL2 <= CONFIG.BPLUS_PRIMARY_L2_MAX &&
    agg.primaryL3 === 0 &&
    agg.primaryStnMax <= CONFIG.BPLUS_PRIMARY_STN_MAX_CM2;
  if(isBPlus) return { grade:"B+", wearI };

  // B: Primary STN ë‹¨ì¼<=20(í™•ì •). ì´ˆê³¼ë©´ X ê¸°ë³¸.
  if(agg.primaryStnMax > CONFIG.B_PRIMARY_STN_MAX_CM2){
    return { grade:"X", wearI:3, note:`Primary ì˜¤ì—¼ ${agg.primaryStnMax}cmÂ² > ${CONFIG.B_PRIMARY_STN_MAX_CM2}cmÂ²` };
  }

  if(hasPrimaryL3) return { grade:"B", wearI:3, note:"Primary L3ë¡œ B ìº¡" };
  return { grade:"B", wearI };
}

function buildOutputs(item, grade, wearI, note){
  const badges = (item.badges||"").trim();
  const wl = wearLabel(wearI);

  const simple = `[${grade}] ${CONFIG.gradeLabels[grade]} / ì‚¬ìš©ê°: ${wl}` +
    (badges ? ` / ë°°ì§€: ${badges}` : "") +
    (item.album_link ? ` / ì‚¬ì§„: ${item.album_link}` : "");

  const lines = item.defects
    .filter(d=>d.code)
    .map(d=>{
      const exp=d.exposure||"", vis=d.visibility||"", code=(d.code||"").toUpperCase();
      const cnt=parseInt(d.count||1,10)||1;
      const mm=parseFloat(d.size_mm||0)||0;
      const cm2=parseFloat(d.area_cm2||0)||0;
      const extra=(d.extra||"").trim();
      let add="";
      if(code==="STN" && cm2) add = ` (ì˜¤ì—¼ ${cm2}cmÂ²)`;
      else if(mm) add = ` (${mm}mm)`;
      if(extra && (code==="PIL"||code==="SAG")) add += ` [${code==="PIL"?"í•„ë§":"êº¼ì§"}:${extra}]`;
      return `- ${exp}/${vis} ${code} x${cnt}${add}`;
    });

  const html =
`<div style="line-height:1.7;">
  <h2>ì»¨ë””ì…˜</h2>
  <p><b>${escapeHtml(CONFIG.gradeLabels[grade] || grade)}</b><br/>
     ì‚¬ìš©ê°: <b>${escapeHtml(wl)}</b>${badges?`<br/>ë°°ì§€: <b>${escapeHtml(badges)}</b>`:""}${item.album_link?`<br/>ì‚¬ì§„ ë§í¬: <a href="${escapeAttr(item.album_link)}" target="_blank">${escapeHtml(item.album_link)}</a>`:""}
  </p>
  <h3>ìš”ì•½</h3>
  <p>${escapeHtml(gradeSummary(grade))}</p>
  ${note?`<p style="color:#666;">ê²€ìˆ˜ ë…¸íŠ¸: ${escapeHtml(note)}</p>`:""}
  <h3>ê²°í•¨/ì‚¬ìš©ê° ê³ ì§€</h3>
  ${lines.length?`<pre style="white-space:pre-wrap;">${escapeHtml(lines.join("\\n"))}</pre>`:"<p>ê¸°ë¡ëœ ê²°í•¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>"}
  <hr/>
  <p style="color:#777; font-size:12px;">í‘œì¤€: ${CONFIG.version}</p>
</div>`;

  return { simple, html };
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function escapeAttr(s){
  // ì•„ì£¼ ê°„ë‹¨íˆ
  return String(s||"").replaceAll('"',"%22");
}

/** UI **/
function renderList(){
  const q = $("q").value.trim().toLowerCase();
  const fg = $("filterGrade").value;
  const sortBy = $("sortBy").value;

  let items = [...state.items];

  if(q){
    items = items.filter(it =>
      (it.name||"").toLowerCase().includes(q) ||
      (it.item_id||"").toLowerCase().includes(q) ||
      (it.grade||"").toLowerCase().includes(q)
    );
  }
  if(fg){
    items = items.filter(it => it.grade === fg);
  }

  items.sort((a,b)=>{
    if(sortBy==="new") return (b.updated_at||0)-(a.updated_at||0);
    if(sortBy==="old") return (a.updated_at||0)-(b.updated_at||0);
    return String(a.name||"").localeCompare(String(b.name||""),"ko");
  });

  const el = $("list");
  el.innerHTML = "";
  items.forEach(it=>{
    const div=document.createElement("div");
    div.className="item";
    div.onclick=()=>selectItem(it.id);
    div.innerHTML = `
      <div class="top">
        <div><b>${escapeHtml(it.name||"(ìƒí’ˆëª… ì—†ìŒ)")}</b></div>
        <div class="pill"><b>${escapeHtml(it.grade||"-")}</b></div>
      </div>
      <div class="meta">
        ID: <span class="kbd">${escapeHtml(it.item_id||"-")}</span><br/>
        ${escapeHtml(it.category||"")} Â· ì‚¬ìš©ê°: ${escapeHtml(it.wear_label||"-")} Â· ${it.status==="final"?"âœ…ì™„ë£Œ":"ğŸ“ì‘ì„±ì¤‘"}
      </div>
    `;
    el.appendChild(div);
  });

  if(!items.length){
    el.innerHTML = `<div class="muted">ëª©ë¡ì´ ë¹„ì–´ìˆì–´ìš”. <span class="kbd">+ ìƒˆ ê²€ìˆ˜</span>ë¥¼ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</div>`;
  }
}

function renderPhotoChecks(item){
  const wrap = $("photoChecks");
  wrap.innerHTML = "";
  CONFIG.photoShots.forEach((label, idx)=>{
    const div=document.createElement("label");
    div.className="check";
    div.innerHTML = `<input type="checkbox" ${item.photos[idx]?"checked":""} /> <span>${escapeHtml(label)}</span>`;
    div.querySelector("input").onchange = (e)=>{
      item.photos[idx] = e.target.checked;
      item.updated_at = Date.now();
      saveState();
    };
    wrap.appendChild(div);
  });
}

function addDefRow(rowData={}){
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td><select class="exposure"></select></td>
    <td><select class="visibility"></select></td>
    <td><select class="code"></select></td>
    <td><input class="size_mm" inputmode="numeric" placeholder="0"/></td>
    <td><input class="area_cm2" inputmode="decimal" placeholder="0"/></td>
    <td><input class="count" inputmode="numeric" placeholder="1"/></td>
    <td><input class="extra" placeholder="PIL:1~5 / SAG:mm"/></td>
    <td class="right"><button class="ghost del">ì‚­ì œ</button></td>
  `;
  const ex=tr.querySelector(".exposure");
  CONFIG.exposure.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; ex.appendChild(o);});
  const vi=tr.querySelector(".visibility");
  CONFIG.visibility.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; vi.appendChild(o);});
  const co=tr.querySelector(".code");
  CONFIG.codes.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; co.appendChild(o);});

  ex.value = rowData.exposure || "Primary";
  vi.value = rowData.visibility || "L1";
  co.value = rowData.code || "SCR";
  tr.querySelector(".size_mm").value = rowData.size_mm ?? "";
  tr.querySelector(".area_cm2").value = rowData.area_cm2 ?? "";
  tr.querySelector(".count").value = rowData.count ?? 1;
  tr.querySelector(".extra").value = rowData.extra ?? "";

  tr.querySelector(".del").onclick = ()=>{
    tr.remove();
    syncDefectsFromUI();
  };

  ["change","input"].forEach(ev=>{
    tr.addEventListener(ev, ()=>syncDefectsFromUI());
  });

  $("defBody").appendChild(tr);
}

function syncDefectsFromUI(){
  const item = getSelectedItem();
  if(!item) return;

  const rows = Array.from($("defBody").querySelectorAll("tr"));
  item.defects = rows.map(tr=>({
    exposure: tr.querySelector(".exposure").value,
    visibility: tr.querySelector(".visibility").value,
    code: tr.querySelector(".code").value,
    size_mm: tr.querySelector(".size_mm").value,
    area_cm2: tr.querySelector(".area_cm2").value,
    count: tr.querySelector(".count").value,
    extra: tr.querySelector(".extra").value
  }));

  item.updated_at = Date.now();
  saveState();
}

function getSelectedItem(){
  return state.items.find(it=>it.id===state.selectedId) || null;
}

function selectItem(id){
  state.selectedId = id;
  saveState();
  const item = getSelectedItem();
  fillForm(item);
}

function fillForm(item){
  if(!item){
    $("selName").textContent="ì—†ìŒ";
    return;
  }
  $("selName").textContent = item.name || item.item_id || "ì„ íƒë¨";

  $("item_id").value = item.item_id || "";
  $("status").value = item.status || "draft";
  $("name").value = item.name || "";
  $("category").value = item.category || "";
  $("price").value = item.price || "";
  $("badges").value = item.badges || "";
  $("album_link").value = item.album_link || "";
  $("gate_x").value = String(!!item.gate_x);
  $("gate_reason").value = item.gate_reason || "";
  $("grade").textContent = item.grade || "-";
  $("wear_label").textContent = item.wear_label || "-";
  $("simple_content").value = item.simple_content || "";
  $("content_html").value = item.content_html || "";
  $("notes").value = item.notes || "";

  // defects
  $("defBody").innerHTML = "";
  (item.defects||[]).forEach(d=>addDefRow(d));

  // photo checks
  renderPhotoChecks(item);
}

function updateItemFromForm(){
  const item = getSelectedItem();
  if(!item) return null;
  item.item_id = $("item_id").value.trim() || item.item_id || todayId();
  item.status = $("status").value;
  item.name = $("name").value.trim();
  item.category = $("category").value.trim();
  item.price = $("price").value.trim();
  item.badges = $("badges").value.trim();
  item.album_link = $("album_link").value.trim();
  item.gate_x = $("gate_x").value === "true";
  item.gate_reason = $("gate_reason").value.trim();
  item.notes = $("notes").value;
  item.updated_at = Date.now();
  syncDefectsFromUI();
  saveState();
  renderList();
  return item;
}

function calcAndFill(){
  const item = updateItemFromForm();
  if(!item) return;

  const res = evaluate(item);
  const grade = res.grade;
  const wearI = res.wearI ?? wearIndex(item.defects);
  const wl = wearLabel(wearI);
  const out = buildOutputs(item, grade, wearI, res.note);

  item.grade = grade;
  item.wear_label = wl;
  item.simple_content = out.simple;
  item.content_html = out.html;
  item.updated_at = Date.now();

  saveState();
  fillForm(item);
  renderList();
  toast(`ìƒì„± ì™„ë£Œ: ë“±ê¸‰ ${grade}, ì‚¬ìš©ê° ${wl}`);
}

function newItem(){
  const it = defaultItem();
  state.items.unshift(it);
  state.selectedId = it.id;
  saveState();
  renderList();
  fillForm(it);
  toast("ìƒˆ ê²€ìˆ˜ ìƒì„±");
}

function deleteSelected(){
  const id = state.selectedId;
  if(!id) return;
  const idx = state.items.findIndex(it=>it.id===id);
  if(idx>=0){
    const name = state.items[idx].name || state.items[idx].item_id;
    state.items.splice(idx,1);
    state.selectedId = state.items[0]?.id || null;
    saveState();
    renderList();
    fillForm(getSelectedItem());
    toast(`ì‚­ì œ: ${name}`);
  }
}

function exportCSV(){
  const cols = ["item_id","status","name","category","price","badges","album_link","gate_x","gate_reason","grade","wear_label","updated_at"];
  const rows = [cols.join(",")];
  state.items.forEach(it=>{
    const r = cols.map(c=>{
      let v = it[c];
      if(c==="updated_at") v = new Date(it.updated_at||0).toISOString();
      const s = String(v??"").replaceAll('"','""');
      return `"${s}"`;
    }).join(",");
    rows.push(r);
  });
  const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
  downloadBlob(blob, `fullty_inspector_${Date.now()}.csv`);
}

function backupJSON(){
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  downloadBlob(blob, `fullty_inspector_backup_${Date.now()}.json`);
}
function restoreJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      if(!obj || !obj.items) throw new Error("í˜•ì‹ ì˜¤ë¥˜");
      state = obj;
      saveState();
      renderList();
      fillForm(getSelectedItem());
      toast("ë³µì› ì™„ë£Œ");
    }catch(e){
      alert("ë³µì› ì‹¤íŒ¨: " + e.message);
    }
  };
  reader.readAsText(file);
}
function wipeAll(){
  if(!confirm("ì •ë§ ì „ì²´ ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”? (ë³µêµ¬ ë¶ˆê°€)")) return;
  state = { items: [], selectedId: null };
  saveState();
  renderList();
  fillForm(null);
  toast("ì „ì²´ ì‚­ì œ");
}

function downloadBlob(blob, filename){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
}

function copyText(value){
  navigator.clipboard.writeText(value).then(()=>toast("ë³µì‚¬ë¨")).catch(()=>toast("ë³µì‚¬ ì‹¤íŒ¨"));
}

/** Bind */
function init(){
  loadState();
  renderList();

  // restore selection
  if(state.selectedId){
    fillForm(getSelectedItem());
  }else if(state.items[0]){
    state.selectedId = state.items[0].id;
    saveState();
    fillForm(getSelectedItem());
  }else{
    fillForm(null);
  }

  $("btnNew").onclick = newItem;
  $("btnCalc").onclick = calcAndFill;
  $("btnSave").onclick = ()=>{ updateItemFromForm(); toast("ì €ì¥ë¨"); };
  $("btnDelete").onclick = deleteSelected;

  $("btnAddDef").onclick = ()=>{ addDefRow(); syncDefectsFromUI(); };
  $("btnClearDef").onclick = ()=>{ $("defBody").innerHTML=""; syncDefectsFromUI(); };

  $("btnCopySimple").onclick = ()=>copyText($("simple_content").value||"");
  $("btnCopyHtml").onclick = ()=>copyText($("content_html").value||"");

  $("q").oninput = renderList;
  $("filterGrade").onchange = renderList;
  $("sortBy").onchange = renderList;

  $("btnCSV").onclick = exportCSV;

  $("btnBackup").onclick = backupJSON;
  $("btnRestore").onclick = ()=>$("restoreFile").click();
  $("restoreFile").onchange = (e)=>{ const f=e.target.files?.[0]; if(f) restoreJSON(f); e.target.value=""; };

  $("btnWipe").onclick = wipeAll;

  // auto-save on blur
  ["item_id","status","name","category","price","badges","album_link","gate_x","gate_reason","notes"].forEach(id=>{
    $(id).addEventListener("change", ()=>updateItemFromForm());
    $(id).addEventListener("blur", ()=>updateItemFromForm());
  });
}
init();
</script>
</body>
</html>
